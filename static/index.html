<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Vix25 Live Chart with Signals</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: #f0f0f0;
      padding: 20px;
    }
    canvas {
      background: #222;
      border: 1px solid #333;
    }
    #signalBox {
      margin-top: 20px;
      background: #1a1a1a;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #333;
    }
    .signal {
      margin-bottom: 10px;
      padding: 10px;
      border-left: 4px solid #0ff;
      background: #2a2a2a;
    }
  </style>
</head>
<body>
  <h2>ğŸ“ˆ Vix25 Live Price Chart with Pattern Signals</h2>
  <canvas id="lineChart" width="1000" height="400"></canvas>

  <div id="signalBox">
    <b>Active Signals:</b><br>
    <i>Waiting for signals...</i>
  </div>

  <script>
    const ctx = document.getElementById("lineChart").getContext("2d");

    const chart = new Chart(ctx, {
      type: "line",
      data: {
        labels: [],
        datasets: [{
          label: "Vix25 Price",
          data: [],
          borderColor: "#0ff",
          borderWidth: 2,
          pointRadius: 0,
          fill: false,
        }]
      },
      options: {
        responsive: true,
        animation: false,
        plugins: {
          legend: { display: true }
        },
        scales: {
          x: {
            ticks: { color: "#ccc" }
          },
          y: {
            ticks: { color: "#ccc" }
          }
        }
      }
    });

    const signalBox = document.getElementById("signalBox");
    let isInitialLoad = true;

    function connectWS() {
      const ws = new WebSocket(`ws://${location.host}/ws`);

      ws.onmessage = (event) => {
        const msg = JSON.parse(event.data);

        // Initial full chart
        if (msg.ticks && isInitialLoad) {
          const labels = msg.ticks.map(t => new Date(t.time * 1000).toLocaleTimeString());
          const data = msg.ticks.map(t => t.price);
          chart.data.labels = labels;
          chart.data.datasets[0].data = data;
          chart.update();
          isInitialLoad = false;
        }

        // Auto-update with latest tick
        if (msg.ticks && msg.ticks.length > 0 && !isInitialLoad) {
          const latest = msg.ticks[msg.ticks.length - 1];
          const timeLabel = new Date(latest.time * 1000).toLocaleTimeString();

          chart.data.labels.push(timeLabel);
          chart.data.datasets[0].data.push(latest.price);

          // Keep chart length at 300
          if (chart.data.labels.length > 300) {
            chart.data.labels.shift();
            chart.data.datasets[0].data.shift();
          }

          chart.update();
        }

        // Update signal box
        if (msg.signals) {
          if (msg.signals.length === 0) {
            signalBox.innerHTML = "<b>Active Signals:</b><br><i>No active signals.</i>";
          } else {
            signalBox.innerHTML = "<b>Active Signals:</b><br>";
            msg.signals.forEach(sig => {
              signalBox.innerHTML += `
                <div class="signal">
                  ğŸ“ Entry: <b>${sig.entry}</b><br>
                  ğŸ¯ TP: <span style="color: #0f0;">${sig.tp}</span><br>
                  ğŸ›‘ SL: <span style="color: #f00;">${sig.sl}</span><br>
                  ğŸ•’ Time: ${new Date(sig.entry_time * 1000).toLocaleTimeString()}
                </div>
              `;
            });
          }
        }
      };

      ws.onerror = () => {
        signalBox.innerHTML = "<b>WebSocket Error</b> - please check your backend.";
      };

      ws.onclose = () => {
        setTimeout(connectWS, 3000); // Try reconnecting
      };
    }

    connectWS();
  </script>
</body>
</html>
